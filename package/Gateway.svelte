<script>
	import IFrame from './IFrame.svelte';
	import { CHANGE } from './iframeSrc/constants.js';
	import { createEventDispatcher } from 'svelte';

	const srcdoc64 = 'PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KCTxoZWFkPgoJCTxtZXRhIGNoYXJzZXQ9InV0Zi04IiAvPgoJCTxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsaW5pdGlhbC1zY2FsZT0xIiAvPgoJCTxzdHlsZT4KCQkJKiB7CgkJCQltYXJnaW46IDA7CgkJCQlwYWRkaW5nOiAwOwoJCQkJLyogIGluY2x1ZGUgcGFkZGluZyBhbmQgdGhlIGJvcmRlciAqLwoJCQkJYm94LXNpemluZzogYm9yZGVyLWJveDsKCQkJCS8qIG1vcmUgcGFkZGluZyBvbiB0aGUgaW5zaWRlIG9mIHlvdXIgYm94LCBidXQgeW91IGRvbid0IHdhbnQgdGhlIGJveCB0byByZXNpemUgKi8KCQkJCS8qIGJveC1zaXppbmc6IGNvbnRlbnQtYm94OyAqLwoJCQl9CgoJCQlib2R5IHsKCQkJCW1hcmdpbjogMDsKCQkJCXBvc2l0aW9uOiByZWxhdGl2ZTsKCQkJfQoJCTwvc3R5bGU+CgkJPHNjcmlwdCBkZWZlciB0eXBlPSJtb2R1bGUiPgoJCQl2YXIgYXBwPWZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2Z1bmN0aW9uIHQoKXt9ZnVuY3Rpb24gZSh0KXtyZXR1cm4gdCgpfWZ1bmN0aW9uIG4oKXtyZXR1cm4gT2JqZWN0LmNyZWF0ZShudWxsKX1mdW5jdGlvbiBvKHQpe3QuZm9yRWFjaChlKX1mdW5jdGlvbiBzKHQpe3JldHVybiJmdW5jdGlvbiI9PXR5cGVvZiB0fWZ1bmN0aW9uIHIodCxlKXtyZXR1cm4gdCE9dD9lPT1lOnQhPT1lfHx0JiYib2JqZWN0Ij09dHlwZW9mIHR8fCJmdW5jdGlvbiI9PXR5cGVvZiB0fWZ1bmN0aW9uIGModCxlLG4pe3QuaW5zZXJ0QmVmb3JlKGUsbnx8bnVsbCl9ZnVuY3Rpb24gaSh0KXt0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodCl9ZnVuY3Rpb24gdSh0KXtyZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0KX1mdW5jdGlvbiBsKHQpe3JldHVybiBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0KX1mdW5jdGlvbiBhKCl7cmV0dXJuIGwoIiIpfWNsYXNzIGR7Y29uc3RydWN0b3IodD0hMSl7dGhpcy5pc19zdmc9ITEsdGhpcy5pc19zdmc9dCx0aGlzLmU9dGhpcy5uPW51bGx9Yyh0KXt0aGlzLmgodCl9bSh0LGUsbj1udWxsKXt2YXIgbzt0aGlzLmV8fCh0aGlzLmlzX3N2Zz90aGlzLmU9KG89ZS5ub2RlTmFtZSxkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIixvKSk6dGhpcy5lPXUoZS5ub2RlTmFtZSksdGhpcy50PWUsdGhpcy5jKHQpKSx0aGlzLmkobil9aCh0KXt0aGlzLmUuaW5uZXJIVE1MPXQsdGhpcy5uPUFycmF5LmZyb20odGhpcy5lLmNoaWxkTm9kZXMpfWkodCl7Zm9yKGxldCBlPTA7ZTx0aGlzLm4ubGVuZ3RoO2UrPTEpYyh0aGlzLnQsdGhpcy5uW2VdLHQpfXAodCl7dGhpcy5kKCksdGhpcy5oKHQpLHRoaXMuaSh0aGlzLmEpfWQoKXt0aGlzLm4uZm9yRWFjaChpKX19bGV0IGY7ZnVuY3Rpb24gcCh0KXtmPXR9ZnVuY3Rpb24gaCgpe2lmKCFmKXRocm93IG5ldyBFcnJvcigiRnVuY3Rpb24gY2FsbGVkIG91dHNpZGUgY29tcG9uZW50IGluaXRpYWxpemF0aW9uIik7cmV0dXJuIGZ9ZnVuY3Rpb24gJCgpe2NvbnN0IHQ9aCgpO3JldHVybihlLG4se2NhbmNlbGFibGU6bz0hMX09e30pPT57Y29uc3Qgcz10LiQkLmNhbGxiYWNrc1tlXTtpZihzKXtjb25zdCByPWZ1bmN0aW9uKHQsZSx7YnViYmxlczpuPSExLGNhbmNlbGFibGU6bz0hMX0pe2NvbnN0IHM9ZG9jdW1lbnQuY3JlYXRlRXZlbnQoIkN1c3RvbUV2ZW50Iik7cmV0dXJuIHMuaW5pdEN1c3RvbUV2ZW50KHQsbixvLGUpLHN9KGUsbix7Y2FuY2VsYWJsZTpvfSk7cmV0dXJuIHMuc2xpY2UoKS5mb3JFYWNoKChlPT57ZS5jYWxsKHQscil9KSksIXIuZGVmYXVsdFByZXZlbnRlZH1yZXR1cm4hMH19Y29uc3QgbT1bXSxnPVtdLGI9W10seT1bXSx2PVByb21pc2UucmVzb2x2ZSgpO2xldCBfPSExO2Z1bmN0aW9uIHcodCl7Yi5wdXNoKHQpfWNvbnN0IHg9bmV3IFNldDtsZXQgRT0wO2Z1bmN0aW9uIGsoKXtjb25zdCB0PWY7ZG97Zm9yKDtFPG0ubGVuZ3RoOyl7Y29uc3QgdD1tW0VdO0UrKyxwKHQpLEwodC4kJCl9Zm9yKHAobnVsbCksbS5sZW5ndGg9MCxFPTA7Zy5sZW5ndGg7KWcucG9wKCkoKTtmb3IobGV0IHQ9MDt0PGIubGVuZ3RoO3QrPTEpe2NvbnN0IGU9Ylt0XTt4LmhhcyhlKXx8KHguYWRkKGUpLGUoKSl9Yi5sZW5ndGg9MH13aGlsZShtLmxlbmd0aCk7Zm9yKDt5Lmxlbmd0aDspeS5wb3AoKSgpO189ITEseC5jbGVhcigpLHAodCl9ZnVuY3Rpb24gTCh0KXtpZihudWxsIT09dC5mcmFnbWVudCl7dC51cGRhdGUoKSxvKHQuYmVmb3JlX3VwZGF0ZSk7Y29uc3QgZT10LmRpcnR5O3QuZGlydHk9Wy0xXSx0LmZyYWdtZW50JiZ0LmZyYWdtZW50LnAodC5jdHgsZSksdC5hZnRlcl91cGRhdGUuZm9yRWFjaCh3KX19Y29uc3QgTT1uZXcgU2V0O2xldCBqO2Z1bmN0aW9uIE8odCxlKXt0JiZ0LmkmJihNLmRlbGV0ZSh0KSx0LmkoZSkpfWZ1bmN0aW9uIE4odCxlLG4sbyl7aWYodCYmdC5vKXtpZihNLmhhcyh0KSlyZXR1cm47TS5hZGQodCksai5jLnB1c2goKCgpPT57TS5kZWxldGUodCksbyYmKG4mJnQuZCgxKSxvKCkpfSkpLHQubyhlKX1lbHNlIG8mJm8oKX1mdW5jdGlvbiBSKHQsbixyLGMpe2NvbnN0e2ZyYWdtZW50Omksb25fbW91bnQ6dSxvbl9kZXN0cm95OmwsYWZ0ZXJfdXBkYXRlOmF9PXQuJCQ7aSYmaS5tKG4sciksY3x8dygoKCk9Pntjb25zdCBuPXUubWFwKGUpLmZpbHRlcihzKTtsP2wucHVzaCguLi5uKTpvKG4pLHQuJCQub25fbW91bnQ9W119KSksYS5mb3JFYWNoKHcpfWZ1bmN0aW9uIFAodCxlKXtjb25zdCBuPXQuJCQ7bnVsbCE9PW4uZnJhZ21lbnQmJihvKG4ub25fZGVzdHJveSksbi5mcmFnbWVudCYmbi5mcmFnbWVudC5kKGUpLG4ub25fZGVzdHJveT1uLmZyYWdtZW50PW51bGwsbi5jdHg9W10pfWZ1bmN0aW9uIFUodCxlKXstMT09PXQuJCQuZGlydHlbMF0mJihtLnB1c2godCksX3x8KF89ITAsdi50aGVuKGspKSx0LiQkLmRpcnR5LmZpbGwoMCkpLHQuJCQuZGlydHlbZS8zMXwwXXw9MTw8ZSUzMX1mdW5jdGlvbiBUKGUscyxyLGMsdSxsLGEsZD1bLTFdKXtjb25zdCBoPWY7cChlKTtjb25zdCAkPWUuJCQ9e2ZyYWdtZW50Om51bGwsY3R4Om51bGwscHJvcHM6bCx1cGRhdGU6dCxub3RfZXF1YWw6dSxib3VuZDpuKCksb25fbW91bnQ6W10sb25fZGVzdHJveTpbXSxvbl9kaXNjb25uZWN0OltdLGJlZm9yZV91cGRhdGU6W10sYWZ0ZXJfdXBkYXRlOltdLGNvbnRleHQ6bmV3IE1hcChzLmNvbnRleHR8fChoP2guJCQuY29udGV4dDpbXSkpLGNhbGxiYWNrczpuKCksZGlydHk6ZCxza2lwX2JvdW5kOiExLHJvb3Q6cy50YXJnZXR8fGguJCQucm9vdH07YSYmYSgkLnJvb3QpO2xldCBtPSExO2lmKCQuY3R4PXI/cihlLHMucHJvcHN8fHt9LCgodCxuLC4uLm8pPT57Y29uc3Qgcz1vLmxlbmd0aD9vWzBdOm47cmV0dXJuICQuY3R4JiZ1KCQuY3R4W3RdLCQuY3R4W3RdPXMpJiYoISQuc2tpcF9ib3VuZCYmJC5ib3VuZFt0XSYmJC5ib3VuZFt0XShzKSxtJiZVKGUsdCkpLG59KSk6W10sJC51cGRhdGUoKSxtPSEwLG8oJC5iZWZvcmVfdXBkYXRlKSwkLmZyYWdtZW50PSEhYyYmYygkLmN0eCkscy50YXJnZXQpe2lmKHMuaHlkcmF0ZSl7Y29uc3QgdD1mdW5jdGlvbih0KXtyZXR1cm4gQXJyYXkuZnJvbSh0LmNoaWxkTm9kZXMpfShzLnRhcmdldCk7JC5mcmFnbWVudCYmJC5mcmFnbWVudC5sKHQpLHQuZm9yRWFjaChpKX1lbHNlICQuZnJhZ21lbnQmJiQuZnJhZ21lbnQuYygpO3MuaW50cm8mJk8oZS4kJC5mcmFnbWVudCksUihlLHMudGFyZ2V0LHMuYW5jaG9yLHMuY3VzdG9tRWxlbWVudCksaygpfXAoaCl9Y2xhc3MgQXskZGVzdHJveSgpe1AodGhpcywxKSx0aGlzLiRkZXN0cm95PXR9JG9uKHQsZSl7Y29uc3Qgbj10aGlzLiQkLmNhbGxiYWNrc1t0XXx8KHRoaXMuJCQuY2FsbGJhY2tzW3RdPVtdKTtyZXR1cm4gbi5wdXNoKGUpLCgpPT57Y29uc3QgdD1uLmluZGV4T2YoZSk7LTEhPT10JiZuLnNwbGljZSh0LDEpfX0kc2V0KHQpe3ZhciBlO3RoaXMuJCRzZXQmJihlPXQsMCE9PU9iamVjdC5rZXlzKGUpLmxlbmd0aCkmJih0aGlzLiQkLnNraXBfYm91bmQ9ITAsdGhpcy4kJHNldCh0KSx0aGlzLiQkLnNraXBfYm91bmQ9ITEpfX1jb25zdCBTPSJjaGFuZ2UiO2Z1bmN0aW9uIEMoZSl7bGV0IG4sbyxzLHI7cmV0dXJue2MoKXt2YXIgdCxlLGM7bj1uZXcgZCghMSksbz1hKCkscz1sKCIgIikscj11KCJkaXYiKSxuLmE9byx0PXIsZT0iY2xhc3MiLG51bGw9PShjPSJjb21wb25lbnQtbW91bnRlci10YXJnZXQiKT90LnJlbW92ZUF0dHJpYnV0ZShlKTp0LmdldEF0dHJpYnV0ZShlKSE9PWMmJnQuc2V0QXR0cmlidXRlKGUsYyksZnVuY3Rpb24odCxlLG4sbyl7bnVsbD09PW4/dC5zdHlsZS5yZW1vdmVQcm9wZXJ0eShlKTp0LnN0eWxlLnNldFByb3BlcnR5KGUsbixvPyJpbXBvcnRhbnQiOiIiKX0ociwiYWxsIiwidW5zZXQiKX0sbSh0LGkpe24ubShlWzBdLGRvY3VtZW50LmhlYWQpLGZ1bmN0aW9uKHQsZSl7dC5hcHBlbmRDaGlsZChlKX0oZG9jdW1lbnQuaGVhZCxvKSxjKHQscyxpKSxjKHQscixpKSxlWzZdKHIpfSxwKHQsW2VdKXsxJmUmJm4ucCh0WzBdKX0saTp0LG86dCxkKHQpe2kobyksdCYmbi5kKCksdCYmaShzKSx0JiZpKHIpLGVbNl0obnVsbCl9fX1mdW5jdGlvbiBIKHQsZSxuKXtsZXR7ZXNNb2R1bGU6b309ZSx7cHJvcHM6c309ZSx7Y3NzOnJ9PWU7Y29uc3QgYz0kKCk7bGV0IGksdSxsLGE7ZnVuY3Rpb24gZCh0KXtpJiZ0JiZpLiRzZXQoey4uLnR9KX12YXIgZjtyZXR1cm4gZj0oKT0+e24oNSxhPSEwKX0saCgpLiQkLm9uX21vdW50LnB1c2goZiksZnVuY3Rpb24odCl7aCgpLiQkLm9uX2Rlc3Ryb3kucHVzaCh0KX0oKCgpPT57aSYmaS4kZGVzdHJveSgpLHUmJlVSTC5yZXZva2VPYmplY3RVUkwodSl9KSksdC4kJHNldD10PT57ImVzTW9kdWxlImluIHQmJm4oMixvPXQuZXNNb2R1bGUpLCJwcm9wcyJpbiB0JiZuKDMscz10LnByb3BzKSwiY3NzImluIHQmJm4oMCxyPXQuY3NzKX0sdC4kJC51cGRhdGU9KCk9PnszNiZ0LiQkLmRpcnR5JiZhJiZvJiZhc3luYyBmdW5jdGlvbigpe24oMCxyPXI/YDxzdHlsZT4ke3J9PC9zdHlsZT5gOiIiKSxpJiYoaS4kZGVzdHJveSgpLFVSTC5yZXZva2VPYmplY3RVUkwodSkpO2NvbnN0IHQ9bmV3IEJsb2IoW29dLHt0eXBlOiJ0ZXh0L2phdmFzY3JpcHQifSk7dT1VUkwuY3JlYXRlT2JqZWN0VVJMKHQpO2NvbnN0IGU9KGF3YWl0IGltcG9ydCh1KSkuZGVmYXVsdDtpZighZXx8IWwpcmV0dXJuO24oMSxsLmlubmVySFRNTD0iIixsKSxuKDQsaT1uZXcgZSh7dGFyZ2V0OmwscHJvcHM6e319KSk7Y29uc3QgYT1pLiQkLnByb3BzO2xldCBmPXt9O09iamVjdC5rZXlzKGEpLm1hcCgodD0+e2ZbdF09aVt0XX0pKTtsZXQgcD1PYmplY3QuYXNzaWduKGYscyk7YyhTLHApLGkuJG9uKCJjaGFuZ2UiLCh0PT57YyhTLHQuZGV0YWlsKX0pKSxkKHApLHUmJlVSTC5yZXZva2VPYmplY3RVUkwodSl9KCksMjQmdC4kJC5kaXJ0eSYmaSYmcyYmZCgpfSxbcixsLG8scyxpLGEsZnVuY3Rpb24odCl7Z1t0PyJ1bnNoaWZ0IjoicHVzaCJdKCgoKT0+e2w9dCxuKDEsbCl9KSl9XX1jbGFzcyBxIGV4dGVuZHMgQXtjb25zdHJ1Y3Rvcih0KXtzdXBlcigpLFQodGhpcyx0LEgsQyxyLHtlc01vZHVsZToyLHByb3BzOjMsY3NzOjB9KX19ZnVuY3Rpb24gQih0KXtsZXQgZSxuO3JldHVybiBlPW5ldyBxKHtwcm9wczp7ZXNNb2R1bGU6dFswXSxwcm9wczp0WzFdfX0pLGUuJG9uKCJjaGFuZ2UiLHRbM10pLHtjKCl7dmFyIHQ7KHQ9ZS4kJC5mcmFnbWVudCkmJnQuYygpfSxtKHQsbyl7UihlLHQsbyksbj0hMH0scCh0LG4pe2NvbnN0IG89e307MSZuJiYoby5lc01vZHVsZT10WzBdKSwyJm4mJihvLnByb3BzPXRbMV0pLGUuJHNldChvKX0saSh0KXtufHwoTyhlLiQkLmZyYWdtZW50LHQpLG49ITApfSxvKHQpe04oZS4kJC5mcmFnbWVudCx0KSxuPSExfSxkKHQpe1AoZSx0KX19fWZ1bmN0aW9uIFgodCl7bGV0IGUsbixzLHIsdT10WzBdJiZCKHQpO3JldHVybntjKCl7dSYmdS5jKCksZT1hKCl9LG0obyxpKXt2YXIgbCxhLGQsZjt1JiZ1Lm0obyxpKSxjKG8sZSxpKSxuPSEwLHN8fChsPXdpbmRvdyxhPSJtZXNzYWdlIixkPXRbMl0sbC5hZGRFdmVudExpc3RlbmVyKGEsZCxmKSxyPSgpPT5sLnJlbW92ZUV2ZW50TGlzdGVuZXIoYSxkLGYpLHM9ITApfSxwKHQsW25dKXt0WzBdP3U/KHUucCh0LG4pLDEmbiYmTyh1LDEpKToodT1CKHQpLHUuYygpLE8odSwxKSx1Lm0oZS5wYXJlbnROb2RlLGUpKTp1JiYoaj17cjowLGM6W10scDpqfSxOKHUsMSwxLCgoKT0+e3U9bnVsbH0pKSxqLnJ8fG8oai5jKSxqPWoucCl9LGkodCl7bnx8KE8odSksbj0hMCl9LG8odCl7Tih1KSxuPSExfSxkKHQpe3UmJnUuZCh0KSx0JiZpKGUpLHM9ITEscigpfX19ZnVuY3Rpb24geih0LGUsbil7bGV0IG8scyxyO3JldHVybltvLHMsYXN5bmMgZnVuY3Rpb24odCl7dD8uZGF0YSYmKHQ/LmRhdGEuaGFzT3duUHJvcGVydHkoImxvYWQiKSYmKG4oMCwoe2VzTW9kdWxlOm8scHJvcHM6c309dC5kYXRhLmxvYWQpLG8sbigxLHMpKSxyPWU9Pnt0LnBvcnRzWzBdLnBvc3RNZXNzYWdlKGUpfSksdD8uZGF0YS5oYXNPd25Qcm9wZXJ0eSgic2V0UHJvcHMiKSYmbigxLHM9dC5kYXRhLnNldFByb3BzKSl9LGZ1bmN0aW9uKHQpe3ImJnQuZGV0YWlsJiZyKHQuZGV0YWlsKX1dfWdsb2JhbFRoaXMuZmV0Y2g9KCk9Pihjb25zb2xlLmxvZygiTnVsbGVkIG91dCBmZXRjaCIpLHtqc29uOigpPT4oe3Jlc3VsdDoibm8gZmV0Y2gsIHNvcnJ5In0pfSksZ2xvYmFsVGhpcy5YTUxIdHRwUmVxdWVzdD1jbGFzc3tjb25zdHJ1Y3Rvcigpe2NvbnNvbGUubG9nKCJOdWxsZWQgb3V0IFhIUiB0b28iKX1vcGVuPSgpPT5udWxsO3NlbmQ9KCk9Pm51bGx9LGdsb2JhbFRoaXMuV2ViU29ja2V0PW51bGwsZ2xvYmFsVGhpcy5FdmVudFNvdXJjZT1udWxsO3JldHVybiBuZXcgY2xhc3MgZXh0ZW5kcyBBe2NvbnN0cnVjdG9yKHQpe3N1cGVyKCksVCh0aGlzLHQseixYLHIse30pfX0oe3RhcmdldDpkb2N1bWVudC5ib2R5LHByb3BzOnt9fSl9KCk7CgoJCTwvc2NyaXB0PgoJPC9oZWFkPgoKCTxib2R5PjwvYm9keT4KPC9odG1sPgo='; const srcdoc = atob(srcdoc64); console.log({ srcdoc });;

	export let esModule; // TODO: Handle error if not found
	export let css = null;
	export let props; // the consumer of this <Gateway bind:props /> component should bind the props to get updates
	export let rendered = false;

	// refresh/reload when esModule changes
	$: if (esModule && iframe) handleLoad();

	let iframe;
	let setProps;

	const dispatch = createEventDispatcher();

	// this fires when props change; emits an event to update any listeners consuming this compiled component
	// $: if (props) dispatch(CHANGE, props);

	$: iframe && iframe.addEventListener('load', handleLoad);

	// Wait for the iframe to load, then configure it
	async function handleLoad() {
		if (!esModule || !iframe) throw new Error('Missing esModule');

		const channel = new MessageChannel();

		channel.port1.onmessage = (e) => {
			// props = { ...props, ...e.data }; // update props on any reply from child
			rendered = true;
			if (props || e.data) dispatch(CHANGE, Object.assign({}, props, e.data)); // this fires when props change; emits an event to update any listeners consuming this compiled component

			setProps = (props) => {
				iframe.contentWindow.postMessage(
					{ setProps: props }, // push the details to the iframe
					'*' // there's only 1 contentWindow on the iframe so it' safe to use '*' as origin
				);
			};
		};

		iframe.contentWindow.postMessage(
			{ load: { esModule, props, css } }, // push the details to loadEsModuleComponent({ esModule, props }) in the iframe
			'*', // there's only 1 contentWindow on the iframe so it' safe to use '*' as origin
			[channel.port2]
		); // enables the iframe to send messages containing prop updates back to the parent
	}

	// update props as they change
	$: if (props && setProps) setProps(props);
</script>

<IFrame bind:iframe {srcdoc} {rendered} />
